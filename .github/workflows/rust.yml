name: Rust

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: macos-13
    steps:
      # Fix for issue: https://github.com/actions/runner-images/issues/8782
      - name: Grant write system permission to TCC
        run: sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "INSERT OR IGNORE INTO access VALUES('kTCCServicePostEvent','/usr/sbin/sshd',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/bin/bash',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/Users/runner/runners/2.311.0/bin/Runner.Worker',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/bin/zsh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'UNUSED',NULL,NULL,170263201),('kTCCServicePostEvent','com.apple.Terminal',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/usr/local/opt/runner/runprovisioner.sh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/usr/sbin/sshd',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/bin/bash',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/bin/zsh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'UNUSED',NULL,NULL,170263201),('kTCCServiceAccessibility','com.apple.Terminal',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/usr/local/opt/runner/runprovisioner.sh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/Users/runner/runners/2.311.0/bin/Runner.Worker',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/usr/sbin/sshd',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/bin/bash',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/bin/zsh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'UNUSED',NULL,NULL,170263201),('kTCCServiceSystemPolicyAllFiles','com.apple.Terminal',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/usr/local/opt/runner/runprovisioner.sh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceMicrophone','/Users/runner/runners/2.311.0/bin/Runner.Worker',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/usr/sbin/sshd',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/bin/bash',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/bin/zsh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','com.apple.Terminal',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/usr/local/opt/runner/runprovisioner.sh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceScreenCapture','/Users/runner/runners/2.311.0/bin/Runner.Worker',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/usr/sbin/sshd',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/bin/bash',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/bin/zsh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'UNUSED',NULL,NULL,170263201),('kTCCServiceScreenCapture','com.apple.Terminal',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/usr/local/opt/runner/runprovisioner.sh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201)"
      - name: Grant write local permission to TCC
        run: sudo sqlite3 "$HOME/Library/Application Support/com.apple.TCC/TCC.db" "INSERT OR IGNORE INTO access VALUES('kTCCServicePostEvent','/usr/sbin/sshd',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/bin/bash',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/Users/runner/runners/2.311.0/bin/Runner.Worker',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/bin/zsh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'UNUSED',NULL,NULL,170263201),('kTCCServicePostEvent','com.apple.Terminal',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/usr/local/opt/runner/runprovisioner.sh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServicePostEvent','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/usr/sbin/sshd',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/bin/bash',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/bin/zsh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'UNUSED',NULL,NULL,170263201),('kTCCServiceAccessibility','com.apple.Terminal',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/usr/local/opt/runner/runprovisioner.sh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceAccessibility','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/Users/runner/runners/2.311.0/bin/Runner.Worker',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/usr/sbin/sshd',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/bin/bash',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/bin/zsh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'UNUSED',NULL,NULL,170263201),('kTCCServiceSystemPolicyAllFiles','com.apple.Terminal',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/usr/local/opt/runner/runprovisioner.sh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceSystemPolicyAllFiles','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceMicrophone','/Users/runner/runners/2.311.0/bin/Runner.Worker',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/usr/sbin/sshd',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/bin/bash',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/bin/zsh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','com.apple.Terminal',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/usr/local/opt/runner/runprovisioner.sh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceMicrophone','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,NULL,170263201),('kTCCServiceScreenCapture','/Users/runner/runners/2.311.0/bin/Runner.Worker',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/usr/sbin/sshd',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/bin/bash',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/bin/zsh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'UNUSED',NULL,NULL,170263201),('kTCCServiceScreenCapture','com.apple.Terminal',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/usr/local/opt/runner/runprovisioner.sh',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201),('kTCCServiceScreenCapture','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,NULL,'UNUSED',NULL,0,170263201)"

      - uses: actions/checkout@v3
      - name: Build
        run: cargo build --verbose --features ci
      - name: Run tests
        run: cargo test --verbose --features ci
